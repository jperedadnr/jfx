/*
 * Jenkins Pipeline script for building OpenJFX.
 *
 * Target: linux-aarch64
 * Versions: dynamic and static
 *
 * Mandatory Job Parameters:
 *   - REPO:  defines what repository to checkout: git@github.com:${REPO}.git
 *   - TAG:   defines the tag used to checkout
 *
 * Optional Job Parameters:
 *   - MILESTONE_FCS:     if set to false: build an early access release; if set to true: build a milestone release
 *   - GLUON_DRM_VERSION: the version of the Gluon DRM library to include in the final SDK
 *
 * Release types:
 *   - fork:         REPO does not equal to gluonhq/gluonjfx
 *   - early access: REPO matches gluonhq/gluonjfx and MILESTONE_FCS is false
 *   - milestone:    REPO matches gluonhq/gluonjfx and MILESTONE_FCS is true
 *
 * Final dynamic SDKs:
 *    - fork:         https://download2.gluonhq.com/openjfx/forks/${REPO_ACCOUNT}/${MAJOR_VERSION}/openjfx-${MAJOR_VERSION}+${TAG}_linux-aarch64_bin-sdk.zip
 *    - early access: https://download2.gluonhq.com/openjfx/${MAJOR_VERSION}/openjfx-${MAJOR_VERSION}-ea+${BUILD_NUMBER}_linux-aarch64_bin-sdk.zip
 *    - milestone:    https://download2.gluonhq.com/openjfx/${MAJOR_VERSION}/openjfx-${MAJOR_VERSION}_linux-aarch64_bin-sdk.zip
 *
 * Final static SDKs:
 *    - fork:         https://download2.gluonhq.com/substrate/javafxstaticsdk/forks/${REPO_ACCOUNT}/openjfx-${MAJOR_VERSION}+${TAG}-linux-aarch64-static.zip
 *    - early access: https://download2.gluonhq.com/substrate/javafxstaticsdk/openjfx-${MAJOR_VERSION}-ea+${BUILD_NUMBER}-linux-aarch64-static.zip
 *    - milestone:    https://download2.gluonhq.com/substrate/javafxstaticsdk/openjfx-${MAJOR_VERSION}-linux-aarch64-static.zip
 */

pipeline {
    agent any

    tools {
        jdk 'openjdk-15'
    }

    environment {
        TOOLCHAIN_DIR = '/opt/aarch64-linux/aarch64'
        PKG_CONFIG_SYSROOT_DIR = '/opt/aarch64-linux/aarch64'
        PKG_CONFIG_LIBDIR = '/opt/aarch64-linux/aarch64/usr/lib/aarch64-linux-gnu/pkgconfig:/opt/aarch64-linux/aarch64/usr/share/pkgconfig'
    }

    stages {
        stage('Verify required REPO parameter') {
            when {
                expression {
                    return params.REPO == ''
                }
            }
            steps {
                error("REPO parameter is required.")
            }
        }

        stage('Verify required TAG parameter') {
            when {
                expression {
                    return params.TAG == ''
                }
            }
            steps {
                error("TAG parameter is required.")
            }
        }

        stage('Clone repository') {
            steps {
                checkout scm: [$class: 'GitSCM', userRemoteConfigs: [[url: "git@github.com:${env.REPO}.git", credentialsId: 'github-account-tiainen']], branches: [[name: "refs/tags/${env.TAG}"]]], poll: false
            }    
        }

        stage('Clean repository') {
            steps {
                sh "git clean -d -x -f"
            }
        }

        /*
         * Load generic environment variables.
         * MAJOR_VERSION: determined from the "jfx.release.*.version" properties in build.properties (i.e. 17, 17.0.1)
         * REPO_ACCOUNT: the GitHub account name of the repository that is being cloned
         */
        stage('Load generic env vars') {
            steps {
                script {
                    env.MAJOR_VERSION = """${sh(
                        returnStdout: true,
                        script: '''#!/bin/bash -xe
                            JFX_MAJOR=$(cat build.properties | grep "^jfx\\.release\\.major\\.version" | cut -d= -f2 | tr -d "\\n")
                            JFX_MINOR=$(cat build.properties | grep "^jfx\\.release\\.minor\\.version" | cut -d= -f2 | tr -d "\\n")
                            JFX_SECURITY=$(cat build.properties | grep "^jfx\\.release\\.security\\.version" | cut -d= -f2 | tr -d "\\n")
                            JFX_PATCH=$(cat build.properties | grep "^jfx\\.release\\.patch\\.version" | cut -d= -f2 | tr -d "\\n")
                            if [[ ${JFX_PATCH} -gt 0 ]]; then
                                echo -n "${JFX_MAJOR}.${JFX_MINOR}.${JFX_SECURITY}.${JFX_PATCH}"
                            elif [[ ${JFX_MINOR} -gt 0 || ${JFX_SECURITY} -gt 0 ]]; then
                                echo -n "${JFX_MAJOR}.${JFX_MINOR}.${JFX_SECURITY}"
                            else
                                echo -n "${JFX_MAJOR}"
                            fi
                        '''
                    )}"""
                    env.REPO_ACCOUNT = """${sh(
                        returnStdout: true,
                        script: 'echo ${REPO} | cut -d/ -f1 | tr -d "\\n"'
                    )}"""
                }
            }
        }

        /*
         * Load environment variables specific to fork builds.
         * BUILD_NUMBER: set to the TAG parameter
         */
        stage('Load env vars (fork)') {
            when {
                not {
                    environment name: 'REPO', value: 'gluonhq/gluonjfx'
                }
            }
            steps {
                script {
                    env.BUILD_NUMBER = """${sh(
                        returnStdout: true,
                        script: 'echo ${TAG} | tr -d "\\n"'
                    )}"""
                }
            }
        }

        /*
         * Load environment variables specific to official builds.
         * BUILD_NUMBER: set to the promoted build number of the promoted tag (i.e. number 3 from the tag 17+3-gluon)
         */
        stage('Load env vars (official)') {
            when {
                environment name: 'REPO', value: 'gluonhq/gluonjfx'
            }
            steps {
                script {
                    env.BUILD_NUMBER = """${sh(
                        returnStdout: true,
                        script: 'echo ${TAG} | cut -d- -f1 | cut -d+ -f2 | tr -d "\\n"'
                    )}"""
                }
            }
        }

        stage('Gradle dynamic build') {
            steps {
                sh "sh gradlew --no-daemon --info --refresh-dependencies -PPROMOTED_BUILD_NUMBER=${env.BUILD_NUMBER} -PCOMPILE_MEDIA=false -PCOMPILE_TARGETS=linux_aarch64 -PTOOLCHAINDIR=${env.TOOLCHAIN_DIR} clean all"
            }
        }

        stage('Add dynamic DRM lib') {
            when {
                not {
                    environment name: 'GLUON_DRM_VERSION', value: ''
                }
            }
            steps {
                sh "scp root@download2.gluonhq.com:/var/www/html/restricted/openjfx/drm/lib-${GLUON_DRM_VERSION}/aarch64/libgluon_drm.so build/artifacts/javafx-sdk-${env.MAJOR_VERSION}/lib/libgluon_drm-${GLUON_DRM_VERSION}.so"
                sh "cd build/artifacts && zip -ur bundles/javafx-sdk-${env.MAJOR_VERSION}.zip javafx-sdk-${env.MAJOR_VERSION}"
            }
        }

        stage('Upload dynamic zip (fork)') {
            when {
                not {
                    environment name: 'REPO', value: 'gluonhq/gluonjfx'
                }
            }
            steps {
                sh "ssh root@download2.gluonhq.com 'mkdir -p /var/www/html/openjfx/forks/${env.REPO_ACCOUNT}/${env.MAJOR_VERSION}'"
                sh "scp build/artifacts/bundles/javafx-sdk-${env.MAJOR_VERSION}.zip root@download2.gluonhq.com:/var/www/html/openjfx/forks/${env.REPO_ACCOUNT}/${env.MAJOR_VERSION}/openjfx-${env.MAJOR_VERSION}-${env.TAG}_linux-aarch64_bin-sdk.zip"
                sh "ssh root@download2.gluonhq.com 'cd /var/www/html/openjfx/forks/${env.REPO_ACCOUNT}/${env.MAJOR_VERSION} && sha256sum openjfx-${env.MAJOR_VERSION}-${env.TAG}_linux-aarch64_bin-sdk.zip > openjfx-${env.MAJOR_VERSION}-${env.TAG}_linux-aarch64_bin-sdk.zip.sha256'"
            }
        }

        stage('Upload dynamic zip (official / ea)') {
            when {
                allOf {
                    environment name: 'REPO', value: 'gluonhq/gluonjfx'
                    environment name: 'MILESTONE_FCS', value: 'false'
                }
            }
            steps {
                sh "scp build/artifacts/bundles/javafx-sdk-${env.MAJOR_VERSION}.zip root@download2.gluonhq.com:/var/www/html/openjfx/${env.MAJOR_VERSION}/openjfx-${env.MAJOR_VERSION}-ea+${env.BUILD_NUMBER}_linux-aarch64_bin-sdk.zip"
                sh "ssh root@download2.gluonhq.com 'cd /var/www/html/openjfx/${env.MAJOR_VERSION} && sha256sum openjfx-${env.MAJOR_VERSION}-ea+${env.BUILD_NUMBER}_linux-aarch64_bin-sdk.zip > openjfx-${env.MAJOR_VERSION}-ea+${env.BUILD_NUMBER}_linux-aarch64_bin-sdk.zip.sha256'"
            }
        }

        stage('Upload dynamic zip (official / fcs)') {
            when {
                allOf {
                    environment name: 'REPO', value: 'gluonhq/gluonjfx'
                    environment name: 'MILESTONE_FCS', value: 'true'
                }
            }
            steps {
                sh "scp build/artifacts/bundles/javafx-sdk-${env.MAJOR_VERSION}.zip root@download2.gluonhq.com:/var/www/html/openjfx/${env.MAJOR_VERSION}/openjfx-${env.MAJOR_VERSION}_linux-aarch64_bin-sdk.zip"
                sh "ssh root@download2.gluonhq.com 'cd /var/www/html/openjfx/${env.MAJOR_VERSION} && sha256sum openjfx-${env.MAJOR_VERSION}_linux-aarch64_bin-sdk.zip > openjfx-${env.MAJOR_VERSION}_linux-aarch64_bin-sdk.zip.sha256'"
            }
        }

        stage('Gradle static build') {
            steps {
                sh "sh gradlew --no-daemon --info --refresh-dependencies -PPROMOTED_BUILD_NUMBER=${env.BUILD_NUMBER} -PCOMPILE_MEDIA=false -PSTATIC_BUILD=true -PCOMPILE_TARGETS=linux_aarch64 -PTOOLCHAINDIR=${env.TOOLCHAIN_DIR} clean all"
            }
        }

        stage('Rename sdk folder) {
            steps {
                sh "mv build/linux_aarch64-sdk build/sdk"
            }
        }

        stage('Add static DRM lib') {
            when {
                not {
                    environment name: 'GLUON_DRM_VERSION', value: ''
                }
            }
            steps {
                sh "scp root@download2.gluonhq.com:/var/www/html/restricted/openjfx/drm/lib-${GLUON_DRM_VERSION}/aarch64/libgluon_drm.a build/sdk/lib/libgluon_drm.a"
            }
        }

        stage('Rename artifacts') {
            steps {
                sh "cp build/sdk/lib/javafx.base.jar build/sdk/lib/javafx-base.jar"
                sh "cp build/sdk/lib/javafx.controls.jar build/sdk/lib/javafx-controls.jar"
                sh "cp build/sdk/lib/javafx.fxml.jar build/sdk/lib/javafx-fxml.jar"
                sh "cp build/sdk/lib/javafx.graphics.jar build/sdk/lib/javafx-graphics.jar"
            }
        }

        stage('Create static zip') {
            steps {
                sh "cd build && zip -r ../javafx-static-sdk-${env.MAJOR_VERSION}.zip sdk"
            }
        }

        stage('Upload static zip (fork)') {
            when {
                not {
                    environment name: 'REPO', value: 'gluonhq/gluonjfx'
                }
            }
            steps {
                sh "ssh root@download2.gluonhq.com 'mkdir -p /var/www/html/substrate/javafxstaticsdk/forks/${env.REPO_ACCOUNT}'"
                sh "scp javafx-static-sdk-${env.MAJOR_VERSION}.zip root@download2.gluonhq.com:/var/www/html/substrate/javafxstaticsdk/forks/${env.REPO_ACCOUNT}/openjfx-${env.MAJOR_VERSION}+${env.TAG}-linux-aarch64-static.zip"
            }
        }

        stage('Upload static zip (official / ea)') {
            when {
                allOf {
                    environment name: 'REPO', value: 'gluonhq/gluonjfx'
                    environment name: 'MILESTONE_FCS', value: 'false'
                }
            }
            steps {
                sh "scp javafx-static-sdk-${env.MAJOR_VERSION}.zip root@download2.gluonhq.com:/var/www/html/substrate/javafxstaticsdk/openjfx-${env.MAJOR_VERSION}-ea+${env.BUILD_NUMBER}-linux-aarch64-static.zip"
                sh "scp javafx-static-sdk-${env.MAJOR_VERSION}.zip root@download2.gluonhq.com:/var/www/html/substrate/javafxstaticsdk/openjfx-${env.MAJOR_VERSION}-latest-linux-aarch64-static.zip"
            }
        }

        stage('Upload static zip (official / fcs)') {
            when {
                allOf {
                    environment name: 'REPO', value: 'gluonhq/gluonjfx'
                    environment name: 'MILESTONE_FCS', value: 'true'
                }
            }
            steps {
                sh "scp javafx-static-sdk-${env.MAJOR_VERSION}.zip root@download2.gluonhq.com:/var/www/html/substrate/javafxstaticsdk/openjfx-${env.MAJOR_VERSION}-linux-aarch64-static.zip"
                sh "scp javafx-static-sdk-${env.MAJOR_VERSION}.zip root@download2.gluonhq.com:/var/www/html/substrate/javafxstaticsdk/openjfx-${env.MAJOR_VERSION}-latest-linux-aarch64-static.zip"
            }
        }
    }
}
